import 'package:flutter/material.dart';
import 'package:torch_light/torch_light.dart'; // Fonar uchun

class LampPage extends StatefulWidget {
  const LampPage({super.key});

  @override
  State<LampPage> createState() => _LampPageState();
}

class _LampPageState extends State<LampPage> {
  double lampValue = 0.0;
  Color selectedColor = const Color(0xffbd8934); // Asosiy oltin rang
  bool isTorchOn = false;

  // Haqiqiy fonarni yoqish/o'chirish
  Future<void> _toggleTorch() async {
    try {
      if (isTorchOn) {
        await TorchLight.disableTorch();
        setState(() => isTorchOn = false);
      } else {
        await TorchLight.enableTorch();
        setState(() => isTorchOn = true);
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Fonarni yoqib bo\'lmadi')),
      );
    }
  }

  // Dinamik fon ranglari (Tanlangan rang va lampa yorqinligiga qarab)
  List<Color> getDynamicBG() {
    if (lampValue < 0.1) return [const Color(0xff161614), const Color(0xff161614)];
    if (lampValue < 0.6) {
      return [selectedColor.withOpacity(0.2), const Color(0xff161614)];
    }
    return [
      selectedColor.withOpacity(0.4 * lampValue),
      selectedColor.withOpacity(0.1),
      const Color(0xff161614)
    ];
  }

  // Chiroq olovining ranglari
  List<Color> getFlameColors() {
    if (lampValue < 0.1) return [Colors.black, Colors.grey];
    return [
      Colors.white,
      selectedColor.withOpacity(0.8),
      selectedColor,
    ];
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          ///*** Dinamik Fon ***///
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            height: double.infinity,
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: getDynamicBG(),
              ),
            ),
          ),
          
          Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Spacer(),

                ///*** Lid (Qopqoq) *** ///
                Container(
                  width: 130,
                  height: 3,
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        const Color(0xff161614),
                        Colors.grey.shade500,
                        const Color(0xff161614),
                      ],
                    ),
                    boxShadow: const [
                      BoxShadow(color: Colors.white, blurRadius: 30, offset: Offset(5, 5)),
                    ],
                  ),
                ),

                Stack(
                  alignment: Alignment.bottomCenter,
                  children: [
                    ///*** Yorqinlik Tarqalishi (KUCHAYTIRILDI) *** ///
                    AnimatedContainer(
                      duration: const Duration(milliseconds: 300),
                      width: 100,
                      height: 100,
                      decoration: BoxDecoration(
                        boxShadow: [
                          BoxShadow(
                            color: lampValue > 0.1 
                                ? selectedColor.withOpacity(lampValue * 0.8) 
                                : Colors.transparent,
                            blurRadius: 200 * lampValue, // Yorug'lik kuchaytirildi
                            spreadRadius: 40 * lampValue, // Atrofga yoyilishi
                            offset: const Offset(0, -10),
                          ),
                        ],
                      ),
                    ),

                    ///*** Flame Light (Olov nuri) *** ///
                    AnimatedContainer(
                      duration: const Duration(milliseconds: 300),
                      width: 20 + (10 * lampValue), // Nur qalinlashadi
                      height: 120,
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: getFlameColors(),
                        ),
                        boxShadow: [
                          BoxShadow(
                            color: lampValue > 0.1 ? Colors.white : Colors.transparent,
                            blurRadius: 30 * lampValue,
                            offset: const Offset(0, 10),
                          ),
                        ],
                      ),
                    ),

                    ///*** Shisha (Glass) ***///
                    Container(
                      width: 128,
                      height: 220,
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [
                            Colors.grey.shade500,
                            Colors.transparent,
                            Colors.grey.shade900.withOpacity(0.2),
                            Colors.transparent,
                            Colors.transparent,
                            Colors.grey.shade900.withOpacity(0.2),
                            Colors.transparent,
                            Colors.grey.shade500,
                          ],
                        ),
                      ),
                    ),
                  ],
                ),

                ///*** Taglik (Base) ***///
                Container(
                  height: 40,
                  width: 130,
                  decoration: BoxDecoration(
                    boxShadow: const [
                      BoxShadow(color: Colors.black, blurRadius: 30, offset: Offset(0, 10)),
                    ],
                    gradient: LinearGradient(
                      colors: [
                        Colors.grey.shade800,
                        Colors.black,
                        Colors.grey.shade800,
                        Colors.black,
                        Colors.grey.shade800,
                      ],
                    ),
                  ),
                ),
                
                const Spacer(),

                ///*** Ranglar Palitrasi va Fonar ***///
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    _colorBtn(const Color(0xffbd8934)), // Oltin
                    _colorBtn(Colors.blueAccent),       // Ko'k
                    _colorBtn(Colors.redAccent),        // Qizil
                    _colorBtn(Colors.greenAccent),      // Yashil
                    const SizedBox(width: 20),
                    
                    // Fonar tugmasi
                    Container(
                      decoration: BoxDecoration(
                        color: Colors.white12,
                        shape: BoxShape.circle,
                      ),
                      child: IconButton(
                        icon: Icon(
                          isTorchOn ? Icons.flashlight_on : Icons.flashlight_off,
                          color: isTorchOn ? Colors.white : Colors.grey,
                        ),
                        onPressed: _toggleTorch,
                      ),
                    ),
                  ],
                ),
                
                const SizedBox(height: 20),

                ///*** Slider (Teparoqqa surilgan) ***///
                Padding(
                  padding: const EdgeInsets.only(bottom: 60.0), // Ekranning tagidan ko'tarildi
                  child: Slider(
                    inactiveColor: Colors.black,
                    activeColor: selectedColor,
                    thumbColor: Colors.white,
                    value: lampValue,
                    onChanged: (newValue) {
                      setState(() {
                        lampValue = newValue;
                      });
                    },
                  ),
                ),
              ],
            ),
          ),
          
          Positioned(
            top: 50,
            left: 20,
            child: IconButton(
              onPressed: () => Navigator.pop(context),
              icon: const Icon(Icons.arrow_back_ios, color: Colors.white),
            ),
          ),
        ],
      ),
    );
  }

  // Rang tugmasini yasaydigan widget
  Widget _colorBtn(Color color) {
    bool isSelected = selectedColor == color;
    return GestureDetector(
      onTap: () => setState(() => selectedColor = color),
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 8),
        width: 30,
        height: 30,
        decoration: BoxDecoration(
          color: color,
          shape: BoxShape.circle,
          border: Border.all(
            color: isSelected ? Colors.white : Colors.transparent,
            width: 2,
          ),
        ),
      ),
    );
  }
}
